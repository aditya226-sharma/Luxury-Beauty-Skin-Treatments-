<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Gurubaksh Beauty</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #d4af37; color: white; padding: 1rem; text-align: center; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .booking-card { background: white; margin: 1rem 0; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .booking-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .booking-id { font-weight: bold; color: #d4af37; }
        .status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.confirmed { background: #d4edda; color: #155724; }
        .booking-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .detail-item { margin-bottom: 0.5rem; }
        .detail-label { font-weight: bold; color: #666; }
        .actions { margin-top: 1rem; }
        .btn { padding: 0.5rem 1rem; margin-right: 0.5rem; border: none; border-radius: 4px; cursor: pointer; }
        .btn-confirm { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .no-bookings { text-align: center; color: #666; padding: 2rem; }
        .stats { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-around; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #d4af37; }
        .stat-label { color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Simran Beauty - Admin Panel</h1>
        <p>Manage Appointments</p>
        <div style="margin-top: 1rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label for="fromDate" style="font-weight: bold;">From:</label>
                    <input type="date" id="fromDate" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label for="toDate" style="font-weight: bold;">To:</label>
                    <input type="date" id="toDate" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <a href="#" onclick="exportToExcel()" class="btn" style="background: #28a745; color: white; text-decoration: none; display: inline-block;">
                    üìä Export to Excel
                </a>
                <button onclick="loadBookings()" class="btn" style="background: #007bff; color: white;">
                    üîÑ Refresh
                </button>
                <button onclick="logout()" class="btn" style="background: #dc3545; color: white;">
                    üö™ Logout
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="stat-number" id="total-bookings">0</div>
                <div class="stat-label">Total Bookings</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pending-bookings">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="confirmed-bookings">0</div>
                <div class="stat-label">Confirmed</div>
            </div>
        </div>
        
        <div id="bookings-container">
            <div class="no-bookings">Loading bookings...</div>
        </div>
    </div>

    <script>
        // Check admin authentication
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            
            if (!isLoggedIn) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }
        
        // Check auth on page load
        if (!checkAuth()) {
            return;
        }
        
        // Set default date range (last 30 days)
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
            document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        });
        
        function loadBookings() {
            // Try to fetch from PHP, fallback to localStorage
            fetch('get-bookings.php')
                .then(response => {
                    if (!response.ok) throw new Error('Server not available');
                    return response.json();
                })
                .then(data => {
                    console.log('Loaded bookings:', data);
                    displayBookings(data);
                })
                .catch(error => {
                    console.log('Server error, using localStorage fallback:', error);
                    const localBookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                    displayBookings(localBookings);
                });
        }
    
    function displayBookings(data) {
        const container = document.getElementById('bookings-container');
        
        // Update statistics
        const totalBookings = data.length;
        const pendingBookings = data.filter(b => b.status === 'pending').length;
        const confirmedBookings = data.filter(b => b.status === 'confirmed').length;
        
        document.getElementById('total-bookings').textContent = totalBookings;
        document.getElementById('pending-bookings').textContent = pendingBookings;
        document.getElementById('confirmed-bookings').textContent = confirmedBookings;
        
        if (data.length === 0) {
            container.innerHTML = '<div class="no-bookings">üìã No bookings found. <a href="booking.html">Create a test booking</a> or <a href="verify-system.php">verify system</a>.</div>';
            return;
        }
                    
        container.innerHTML = data.map(booking => `
                        <div class="booking-card">
                            <div class="booking-header">
                                <span class="booking-id">Token: #${booking.token_number || booking.id}</span>
                                <span class="status ${booking.status || 'pending'}">${(booking.status || 'pending').toUpperCase()}</span>
                            </div>
                            <div class="booking-details">
                                <div class="detail-item">
                                    <div class="detail-label">üé´ Token Number:</div>
                                    <div><strong style="color: #d4af37; font-size: 1.2em;">#${booking.token_number || 'N/A'}</strong></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üë§ Customer Name:</div>
                                    <div><strong>${booking.name || 'N/A'}</strong></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üì± Phone Number:</div>
                                    <div><strong>+91 ${booking.phone || 'N/A'}</strong></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üìß Email Address:</div>
                                    <div>${booking.email || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üíÑ Service Requested:</div>
                                    <div><strong>${booking.service || 'N/A'}</strong></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üìÖ Appointment Date:</div>
                                    <div><strong>${booking.date || 'N/A'}</strong></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">‚è∞ Appointment Time:</div>
                                    <div><strong>${booking.time || 'N/A'}</strong></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üí¨ Special Requests:</div>
                                    <div style="font-style: italic;">${booking.message || 'No special requests'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üìù Booking Created:</div>
                                    <div>${booking.created_at || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üìä Current Status:</div>
                                    <div><span class="status ${booking.status || 'pending'}" style="padding: 4px 8px; border-radius: 12px;">${(booking.status || 'pending').toUpperCase()}</span></div>
                                </div>
                            </div>
                            <div class="actions">
                                ${(booking.status || 'pending') === 'pending' ? `<button class="btn btn-confirm" onclick="updateStatus('${booking.id || booking.token_number}', 'confirmed')">‚úÖ Confirm</button>` : ''}
                                <button class="btn btn-delete" onclick="deleteBooking('${booking.id || booking.token_number}')">üóëÔ∏è Delete</button>
                                <a href="https://wa.me/91${booking.phone}?text=Hello ${booking.name}, your appointment (Token: ${booking.token_number}) has been confirmed at Simran Beauty Parlour." target="_blank" class="btn" style="background: #25D366; color: white; text-decoration: none; display: inline-block;">üì± WhatsApp</a>
                            </div>
                        </div>
        `).join('');
        }
        
        function updateStatus(id, status) {
            // Try PHP first, fallback to localStorage
            fetch('update-booking.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, status })
            })
            .then(response => {
                if (!response.ok) throw new Error('Server not available');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    loadBookings();
                } else {
                    alert('Error updating booking');
                }
            })
            .catch(error => {
                // Fallback to localStorage
                let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                const bookingIndex = bookings.findIndex(b => b.token_number === id || b.id === id);
                if (bookingIndex !== -1) {
                    bookings[bookingIndex].status = status;
                    localStorage.setItem('bookings', JSON.stringify(bookings));
                    loadBookings();
                }
            });
        }
        
        function deleteBooking(id) {
            if (confirm('Are you sure you want to delete this booking?')) {
                // Try PHP first, fallback to localStorage
                fetch('delete-booking.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Server not available');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        loadBookings();
                    } else {
                        alert('Error deleting booking');
                    }
                })
                .catch(error => {
                    // Fallback to localStorage
                    let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                    bookings = bookings.filter(b => b.token_number !== id && b.id !== id);
                    localStorage.setItem('bookings', JSON.stringify(bookings));
                    loadBookings();
                });
            }
        }
        
        // Load bookings on page load
        loadBookings();
        
        // Export to Excel function
        function exportToExcel() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            // Create URL with parameters for direct download
            const params = new URLSearchParams({
                'auth_token': 'simran_admin_2024',
                'from_date': fromDate,
                'to_date': toDate
            });
            
            // Open in new window to trigger download
            window.open('secure-export.php?' + params.toString(), '_blank');
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            window.location.href = 'admin-login.html';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            if (document.getElementById('toDate')) {
                document.getElementById('toDate').value = today.toISOString().split('T')[0];
            }
            if (document.getElementById('fromDate')) {
                document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            }
            
            // Load bookings after DOM is ready
            loadBookings();
        });
        
        // Refresh every 30 seconds
        setInterval(loadBookings, 30000);
    </script>
</body>
</html>